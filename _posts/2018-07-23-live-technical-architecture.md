---
layout: post
title: "浅谈直播技术架构"
comments: true
keywords: ""
author: '丁'
---

本文的目的在于让读者能够在宏观上简单直观的了解直播开播流程、直播相关的技术解决方案。

#### 1、构建一个直播平台所需要解决的问题

* 视频采集、处理、播放
* 直播推流、拉流的网络延迟
* 直播的实时鉴黄和敏感词过滤
* 直播弹幕解决方案
* 大流量下的可用性

#### 2、先从一张图了解直播的完整流程

![blockchain](http://doc.husor.com/download/attachments/93619188/image2018-1-12+14%3A2%3A6.png?version=1&modificationDate=1515736924000 "直播时序图")

#### 3、相应的技术难点及解决方案

##### 3.1 视频处理解决方案

视频采集、编码、压缩采用 vitamio（https://www.vitamio.org/） 多媒体开发框架，全面支持硬解码和GPU渲染 

美颜、贴纸、滤镜等可结合第三方服务商（如商汤https://www.sensetime.com/，陌陌AI美颜）

难点：安卓机型适配、中端配置机型优化、特定机型视频处理调优、特殊场景视频处理调优(直播时来电话等)

##### 3.2 直播推流、拉流延迟的解决方案

**直播画面延迟的主要因素：**

1. 采集端网络抖动(手机信号不稳定) 
2. 采集端视频处理优化不到位
3. 流媒体分发不稳定

成本问题，绝大多数公司采用的是第三方流媒体分发服务商（网宿、腾讯、金山、阿里等）

推流采用rtmp流媒体传输协议，拉流可采用rtmp、http flv、HLS等协议，同时通过服务商CDN分发能有效的减少直播画面的延迟问题

![blockchain](http://doc.husor.com/download/attachments/93619188/image2018-1-11+11%3A41%3A47.png?version=1&modificationDate=1515642105000 "推流、拉流时序图")

RTMP协议：RTMP是Adobe公司开发一个基于TCP的应用层协议，主要用于音视频数据通信。RTMP通信主要分为以下几个步骤：建立连接->创建RTMP流->发送FLA-TAG格式封装的音视频包。优势主要有一下几点：

1. 编码器输出的工业标准协议，绝大多数的摄像头、摄像机都支持rtmp输出
2. 长时间的稳定播放
3. 延迟低，但是会有积累延迟

NGB调度：NGB（Next Generation Broadcasting Network），中国下一代广播电视网，是由科技部和广电总局联合组织开发建设，以有线电视网数字化整体转换和移动多媒体广播电视(CMMB)的成果为基础，以自主创新的“高性能宽带信息网”核心技术为支撑，构建的适合我国国情的、“三网融合”的、有线无线相结合的、全程全网的下一代广播电视网络。NGB调度指的是分配服务商提供的推流带宽资源。

CDN分发：通俗的解释就是把用户的请求重新导向到距离最近、通信最佳的服务节点上。直播推流和拉流通过CDN分发能够更好降低延时，提高直播的流畅度。

##### 3.3 直播的实时鉴黄和敏感词过滤

鉴黄主要通过两个渠道：

1. 人工后台监控
2. 自动脚本结合第三方服务商（间隔一定的时间捕获一张直播截图，然后鉴定图片属性。一般有确认、怀疑、普通三种等级，分别做相应处理）

敏感词过滤主要有两个渠道：

1. 自建敏感词库过滤
2. 第三方服务商提供的敏感词过滤（网易易盾等）

##### 3.4 直播弹幕解决方案

弹幕的定义：用户评论消息、用户赠送礼物、用户点赞、高level用户进入特效等都统一可称为弹幕，只是消息类型和展示的效果不一样。
弹幕的上行和下行区分：上行可以称为发送消息的行为，如用户发送评论、点赞、刷礼物进入直播间等，下行可以称为接收消息的过程。

弹幕解决方案目前主要有一下两种方式：

* 方案一：短链接+客户端轮询的方式，客户端指定频次调用api接口查询弹幕信息。
* 方案二：长连接+用户订阅/广播推送，一般上行行为走业务api集群，下行走长连接。

![blockchain](http://doc.husor.com/download/attachments/93619188/image2018-1-11+9%3A59%3A26.png?version=1&modificationDate=1515635964000 "弹幕时序图")

**直播弹幕的相关优化策略：**

1. 静态资源本地化（动画图片素材、音频素材）
2. 服务降级（提高评论间隔时间、接口限速）
3. 弹幕消息的分级处理（礼物优先级最高、高level用户进入直播间|评论、普通用户进入直播间|评论、点赞、其他）
4. 业务集群的动态伸缩
5. 缓存延迟落地

#### 4、直播技术体系的发展

##### 4.1 直播云

直播云的兴起和快速发展，成熟的技术架构和稳定性，可为中小企业提供一站式的直播服务（采集端sdk、转码、水印、鉴黄、录制、连麦等）。企业只需要专注于自身的业务逻辑与直播云的结合，节省大量的技术成本，提升企业竞争力。

接入云后的直播架构

![blockchain](https://odum9helk.qnssl.com/FnjQPTi0LdV4bpcG9BDhmKnjbUGr "弹幕时序图")

##### 4.2 AI在直播中的应用

AI在直播技术体系中的应用已经比较广泛了，如网易易盾为鉴黄和敏感词过滤所建立的基于AI的算法模型，陌陌的AI美颜等。

##### 4.3 AR、VR技术在直播中的应用

通过VR的方式观看直播甚至是AR互动（扯得比较远了，但是不是没可能）
